# 创造图形界面库
*7/8*
*7/11更新*

## 引言

在我接触电脑的十年里，我知道了很多用来构建图形用户界面的框架。在知道Visual Basic之前，图形界面如何制造的问题一直对我来说是个神秘的领域，当然后来知道了X窗口系统家族，才明白Visual Basic隐藏了相当多的细节，也明白GUI的背后其实是很复杂的系统，其中牵涉到图形学、拓扑学、统筹学等等众多方面。

学了Python之后，一直被它简洁的语法吸引，也一直很好奇为什么没有主流GUI框架使用Python作为底层实现的语言。总之，我是不愿意读Gtk Cairo或是Pixman的源码的。

**现在我对于这个问题的猜想是，也许Python解释器的性能不足以实时完成众多色块合成的任务，或是Python作为动态语言不适合做这些计算富集度高的任务。*

**Cairo底层使用Pixman作为处理图像区域的库，Pixman的官网上这样说：*

> There is currently no documentation besides the source code itself. 

-----

我和Harvey基友在高一暑假使用Pygame作为后端成功写成了一个可用的分布式（借助rpyc分布式框架）的GUI框架，这个框架的运行需要一个服务端程序，负责接受客户端请求并绘制在指定窗口、从系统中读取事件并发布给客户端。当时我们还根本不清楚X窗口系统的具体运作方式，仅仅凭借自己对GUI运行机制的推测设计了这个框架。我真的很为我们的智商折服。

做完这个框架之后，我感到还不满意，Pygame众多对SDL二进制库的动态链接使我感到非常*不安*，我性格中有不爱依赖的元素，总是会思考一个问题，

> 如果把我们的框架放到其他不同的平台上，如何使它完美运行？

显然Pygame无法满足跨平台的需求，而且它依赖的部件实在是太多了，为某个特定平台一一编译是不明智的选择。更何况，**pygame貌似已经停止更新了。**

我的想法是，在完全使用Python的基础上，实现一个尽可能对平台依赖少的图形界面库。

- 完全使用Python

意思是所有提供给外部调用的API、所有内部实现使用的抽象组件（Surface、Widget等）使用单一Python语言撰写。

- 尽可能对平台依赖少

意思是抽象组件的实现（如Surface对象的blit方法等）是跨平台的，只要Python解释器能够在某个平台上运行，就能够使用这些抽象组件构建图形用户界面的抽象框架。

这里要说明一点，图形库的最终呈现方式是多样的，可以是通过framebuffer, X, OpenGL，我们想实现多种输出输入渠道，但不能保证这些渠道都是跨平台的。当然这是后面要考虑的问题了。

我们开始吧。

## 底层实现

这些算法都是Harvey和我经过无数次讨论研究出来的。

先实现图形输出端。首先我们需要一种通用的像素图形表示、存储、合成方法。

用矢量图来存储图形当然是最好的，但是不适合通常屏幕输出，因为每次输出都要计算出每个像素上的颜色，开销很大。我觉得还是很规矩的逐个表示像素比较合适，因为以后blit等变幻会方便一些。

接下来需要一种映射关系，用来将屏幕上的点（虽然目前还没有输出）与我设定的数据结构里的元素一一对应，屏幕是二维的，当然最先想到用二维数组，但是Python的二维数组同样也是开销很大的，而且相当没必要，按照我看到的资料，描述一张矩形图像其实只需要三个必须元素，

1. buffer: 储存每个像素的颜色信息
2. mode: 颜色信息的含义，如RGB24, RGBA32
3. size: 图像的长宽

以常用的建系方法，采用左上角为原点，右为x正方向，下为y正方向，我们得到了坐标系里任意一点(x, y)在buffer一维数组里的位置，

$$ (x, y) \rightarrow (y*width + x) $$

这样解决了像素的储存的问题。

下面解决像素合成的问题，根据[wikipedia](https://en.wikipedia.org/wiki/Alpha_compositing)上的算法，两个透明的像素可以这样合成，其中f代表前景，b代表背景，out代表生成物。

$$ out_{alpha} = f_{alpha} + b_{alpha} ( 1-f_{alpha} ) $$

$$ out_{RGB} = (f_{RGB}f_{alpha} + b_{RGB}b_{alpha}(1 - f_{alpha})) \div out_{alpha} $$

**我喜欢用前景和背景的概念，wiki上使用的是src和dst的概念，并且需要记住`src over dst`，可能这是专业的说法。*

关于像素的表示，当然是采用业界通用的RGBA表示方法，但是单纯的建立一个四元素的数组来表示每一个像素，开销也是很大（写到这里，我开始觉得Python也许确实不适合这类底端问题），Harvey认为我们别无选择，我认为可以采用单一整数表示任意一种颜色，这样能够节省空间，也许也能够节省运算，Harvey赞同节省空间这一说法。

我发现，这个单一整数可以这样得到，对于RGBA32(255, 125, 0, 0)，根据[wikipedia](https://en.wikipedia.org/wiki/RGBA_color_space)上的十六进制表示方法，可以表示成0xff7d0000，因为32位char正好平均分给四个值，但是到目前为止我都没有找到可以直接使用此数代入上述公式得到正确答案的方法。

Will be updated...

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>